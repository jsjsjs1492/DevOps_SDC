pipeline {
  agent any

  environment {
    DOCKER_REGISTRY   = 'jangcker'
    BACKEND_IMAGE     = 'dev-community-backend'
    FRONTEND_IMAGE    = 'dev-community-frontend'
    BACKEND_SERVER    = 'ubuntu@52.78.59.185'
    FRONTEND_SERVER   = 'ubuntu@13.124.40.201'
    BACKEND_PORT      = '8081'
    FRONTEND_PORT     = '5001'
    BACKEND_URL       = "52.78.59.185"
    FRONTEND_URL      = "13.124.40.201"
  }

  stages {
    stage('0-1. ë°±ì—”ë“œ ì»¨í…Œì´ë„ˆ ì •ë¦¬') {
      steps {
        sshagent(['admin']) {
          
            sh """
              ssh -o StrictHostKeyChecking=no ${BACKEND_SERVER} '
                cd /home/ubuntu/deploy &&

                export DOCKER_REGISTRY="jangcker"
                export BACKEND_IMAGE="dev-community-backend"
                export BACKEND_PORT="8081"

                ################################################################################
                # 1) DB ì—°ê²° í™˜ê²½ ë³€ìˆ˜ export
                ################################################################################
                export SPRING_DATASOURCE_URL="jdbc:mysql://db:3306/dev_community?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC&characterEncoding=UTF-8"
                export SPRING_DATASOURCE_USERNAME="root"
                export SPRING_DATASOURCE_PASSWORD="1234"

                ################################################################################
                # 2) Mail ì„œë²„ í™˜ê²½ ë³€ìˆ˜ export
                ################################################################################
                export MAIL_HOST="mail.sogang.ac.kr"
                export MAIL_PORT="465"
                export MAIL_USERNAME=""
                export MAIL_PASSWORD=""

                ################################################################################
                # 3) Docker Compose: ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¢…ë£Œ 
                ################################################################################
                docker compose -f docker-compose.backend.yml down || true 
              '
            """
          
        }
      }
    }

    // ================================================================
    stage('0-2. í”„ë¡ íŠ¸ ì»¨í…Œì´ë„ˆ ì •ë¦¬') {
      steps {
        sshagent(['admin']) {
          sh """
            ssh -o StrictHostKeyChecking=no ${FRONTEND_SERVER} '
              cd /home/ubuntu/deploy &&


              # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
              # 1) DOCKER ë ˆì§€ìŠ¤íŠ¸ë¦¬ ë° ì´ë¯¸ì§€ ì´ë¦„ í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
              # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
              export DOCKER_REGISTRY="jangcker"
              export FRONTEND_IMAGE="dev-community-frontend"
              export FRONTEND_PORT="5002"

              # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
              # 2) í”„ë¡ íŠ¸ì—”ë“œ(nginx) ì»¨í…Œì´ë„ˆ ì¢…ë£Œë£Œ
              # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
              docker compose -f docker-compose.frontend.yml down --remove-orphans || true
              docker compose -f docker-compose.frontend.yml down || true

              
            '
          """
        }
      }
    }
    // ================================================================
    stage('1. GitHub ì½”ë“œ Pull') {
      steps {
        git credentialsId: 'github-credentials',
            url: 'https://github.com/jsjsjs1492/deploy_test.git',
            branch: 'main'
      }
    }

    // ================================================================
    stage('2. React í…ŒìŠ¤íŠ¸ìš© .env.production ìƒì„± (í”„ë¡ íŠ¸)') {
      steps {
        dir('dev-community/dev-community-frontend') {
          writeFile file: '.env.production', text: """
REACT_APP_API_URL=http://backend:8081
"""
        }
      }
    }

    // ================================================================
    stage('3. Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° Push') {
      steps {
        script {
          docker.withRegistry('', 'dockerhub-credential') {
            // ë°±ì—”ë“œ ì´ë¯¸ì§€ ë¹Œë“œ
            sh 'docker build -t ${DOCKER_REGISTRY}/${BACKEND_IMAGE}:latest dev-community/dev-community-backend'
            // í”„ë¡ íŠ¸ì—”ë“œ ì´ë¯¸ì§€ ë¹Œë“œ
            sh 'docker build -t ${DOCKER_REGISTRY}/${FRONTEND_IMAGE}:latest dev-community/dev-community-frontend'
            // Docker Hubì— Push
            sh 'docker push ${DOCKER_REGISTRY}/${BACKEND_IMAGE}:latest'
            sh 'docker push ${DOCKER_REGISTRY}/${FRONTEND_IMAGE}:latest'
          }
        }
      }
    }

    stage('4. Test Containers Up') {
      steps {
        dir('dev-community/'){
          sh '''

            echo "ğŸš€ í…ŒìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆ ê¸°ë™"
            docker-compose -f docker-compose.test.yml up -d
          '''
        }
      }
    }

    stage('5. ì  í‚¨ìŠ¤ ë¡œì»¬ì—ì„œ Cypress E2E Test') {
      steps {
        dir('dev-community/'){
          sh 'docker-compose -f docker-compose.test.yml run --exit-code-from cypress cypress'
        }
      }
    }

    stage('6. Test Containers Down') {
      steps {
        dir('dev-community/'){
          sh 'docker-compose -f docker-compose.test.yml down'
          sh 'docker system prune -f'
          sh 'docker volume prune -f'
        }
      }
    }

    stage('7. React ë°°í¬ìš© .env.production ë®ì–´ì“°ê¸°ê¸° (í”„ë¡ íŠ¸)') {
      steps {
        dir('dev-community/dev-community-frontend') {
          writeFile file: '.env.production', text: """
REACT_APP_API_URL=http://${BACKEND_URL}:${BACKEND_PORT}
"""
        }
      }
    }

    stage('8. í”„ë¡ íŠ¸ Docker ì´ë¯¸ì§€ ë¦¬ë¦¬ë¹Œë“œ ë° Push') {
      steps {
        script {
          docker.withRegistry('', 'dockerhub-credential') {
            // í”„ë¡ íŠ¸ì—”ë“œ ì´ë¯¸ì§€ ë¹Œë“œ
            sh 'docker build -t ${DOCKER_REGISTRY}/${FRONTEND_IMAGE}:latest dev-community/dev-community-frontend'
            // Docker Hubì— Push
            sh 'docker push ${DOCKER_REGISTRY}/${FRONTEND_IMAGE}:latest'
          }
        }
      }
    }


    // ================================================================
    stage('9. ë¦¬ëª¨íŠ¸ ì„œë²„ì— Compose íŒŒì¼ ì „ì†¡') {
      steps {
        sshagent(['admin']) {
          sh """
        
            # ë°±ì—”ë“œ ì„œë²„ì— ë””ë ‰í† ë¦¬ ìƒì„± ë° Compose íŒŒì¼ ë³µì‚¬
            ssh -o StrictHostKeyChecking=no ${BACKEND_SERVER} 'mkdir -p /home/ubuntu/deploy'
            scp ./dev-community/docker-compose.backend.yml ${BACKEND_SERVER}:/home/ubuntu/deploy/

            # í”„ë¡ íŠ¸ì—”ë“œ ì„œë²„ì— ë””ë ‰í† ë¦¬ ìƒì„± ë° Compose íŒŒì¼ ë³µì‚¬
            ssh -o StrictHostKeyChecking=no ${FRONTEND_SERVER} 'mkdir -p /home/ubuntu/deploy'
            scp ./dev-community/docker-compose.frontend.yml ${FRONTEND_SERVER}:/home/ubuntu/deploy/
          """
        }
      }
    }

    // ================================================================
    stage('10. ë°±ì—”ë“œ ë° DB ì„œë²„ ê¸°ë™ (SSH ë‚´ export)') {
      steps {
        sshagent(['admin']) {
          
            sh """
              ssh -o StrictHostKeyChecking=no ${BACKEND_SERVER} '
                cd /home/ubuntu/deploy &&

                export DOCKER_REGISTRY="jangcker"
                export BACKEND_IMAGE="dev-community-backend"
                export BACKEND_PORT="8081"

                ################################################################################
                # 1) DB ì—°ê²° í™˜ê²½ ë³€ìˆ˜ export
                ################################################################################
                export SPRING_DATASOURCE_URL="jdbc:mysql://db:3306/dev_community?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC&characterEncoding=UTF-8"
                export SPRING_DATASOURCE_USERNAME="root"
                export SPRING_DATASOURCE_PASSWORD="1234"

                ################################################################################
                # 2) Mail ì„œë²„ í™˜ê²½ ë³€ìˆ˜ export
                ################################################################################
                export MAIL_HOST="mail.sogang.ac.kr"
                export MAIL_PORT="465"
                export MAIL_USERNAME=""
                export MAIL_PASSWORD=""

                ################################################################################
                # 3) Docker Compose: ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¢…ë£Œ â†’ ìµœì‹  ì´ë¯¸ì§€ Pull â†’ ì‹ ê·œ ê¸°ë™
                ################################################################################
                docker compose -f docker-compose.backend.yml down || true &&
                docker compose -f docker-compose.backend.yml pull &&
                docker compose -f docker-compose.backend.yml up -d
              '
            """
          
        }
      }
    }

    // ================================================================
    stage('11. í”„ë¡ íŠ¸ ê¸°ë™') {
      steps {
        sshagent(['admin']) {
          sh """
            ssh -o StrictHostKeyChecking=no ${FRONTEND_SERVER} '
              cd /home/ubuntu/deploy &&

          
              # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
              # 1) DOCKER ë ˆì§€ìŠ¤íŠ¸ë¦¬ ë° ì´ë¯¸ì§€ ì´ë¦„ í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
              # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
              export DOCKER_REGISTRY="jangcker"
              export FRONTEND_IMAGE="dev-community-frontend"
              export FRONTEND_PORT="5002"

              # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
              # 2) í”„ë¡ íŠ¸ì—”ë“œ(nginx) ì»¨í…Œì´ë„ˆ ì¢…ë£Œ í›„, ë¹Œë“œëœ ìµœì‹  ì´ë¯¸ì§€ë¡œ ê¸°ë™
              # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
              docker compose -f docker-compose.frontend.yml down --remove-orphans || true
              docker compose -f docker-compose.frontend.yml down || true
              docker compose -f docker-compose.frontend.yml pull
              docker compose -f docker-compose.frontend.yml up -d frontend

              
            '
          """
        }
      }
    }// stages
  }
  // ================================================================
  post {
    success {
      echo "âœ… ì „ì²´ ë°°í¬ ë° í…ŒìŠ¤íŠ¸ ì„±ê³µ"
    }
    failure {
      echo "âŒ ì‹¤íŒ¨: ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”"
    }
  }
} // pipeline

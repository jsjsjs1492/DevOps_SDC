# dev-community/nginx/default.conf
server {
    listen 80; # Nginx 컨테이너가 들을 포트 (Dockerfile의 EXPOSE 80과 연결)
    server_name localhost; # 개발 및 내부 테스트용. 실제 배포 시 도메인 또는 IP를 명시할 수 있습니다.

    # 1. 프론트엔드 정적 파일 서빙 설정
    # 모든 요청에 대해 기본적으로 React 앱의 정적 파일(HTML, CSS, JS)을 제공합니다.
    # React SPA (Single Page Application) 라우팅을 위해 파일이 없으면 index.html을 반환합니다.
    location / {
        root /usr/share/nginx/html;
        index index.html index.htm;
        try_files $uri $uri/ /index.html;
    }

    # 2. 백엔드 API 요청 프록시 설정
    # 프론트엔드에서 특정 경로로 시작하는 요청이 오면, Nginx가 이를 가로채서
    # Docker 네트워크의 'backend' 서비스(백엔드 컨테이너)로 전달합니다.
    # '$request_uri' 변수를 사용하여 클라이언트가 요청한 전체 URI를 그대로 백엔드에 전달합니다.
    # 'backend'는 docker-compose.yml 파일에 정의된 백엔드 서비스의 이름입니다.

    # 2-1. 인증 및 멤버 관련 API (auth, member)
    location ~ ^/(auth|member)/ {
        proxy_pass http://backend:8081$request_uri;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 2-2. 게시글 관련 API (post)
    location /post/ {
        proxy_pass http://backend:8081$request_uri;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 2-3. 댓글 관련 API (comment)
    location /comment/ {
        proxy_pass http://backend:8081$request_uri;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 3. 에러 및 액세스 로그 설정 (컨테이너 내부 경로)
    error_log /var/log/nginx/error.log warn;
    access_log /var/log/nginx/access.log main;
}